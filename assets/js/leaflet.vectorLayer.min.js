(function(){vectorLayer.Layer=L.Class.extend({options:{scaleRange:null,map:null,cluster:!1,uniqueField:null,visibleAtScale:!0,dynamic:!1,autoUpdate:!1,autoUpdateInterval:null,popupTemplate:null,popupOptions:{},singlePopup:!1,symbology:null,showAll:!1,focus:!1,above:!1},initialize:function(a){return L.Util.setOptions(this,a)},setMap:function(a){var c;if(!a||!this.options.map){if(a)return this.options.map=a,this.options.scaleRange&&(this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length)&&
(c=this.options.map.getZoom(),a=this.options.scaleRange,this.options.visibleAtScale=c>=a[0]&&c<=a[1]),this._show();if(this.options.map)return this._hide(),this.options.map=a}},getMap:function(){return this.options.map},setOptions:function(a){return L.Util.setOptions(this,a)},redraw:function(){this._hide();return this._show()},_show:function(){var a=this;this._addIdleListener();this.options.scaleRange&&(this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length)&&this._addZoomChangeListener();
if(this.options.visibleAtScale)return this.options.autoUpdate&&this.options.autoUpdateInterval&&(this._autoUpdateInterval=setInterval(function(){return a._getFeatures()},this.options.autoUpdateInterval)),this.options.map.fire("moveend").fire("zoomend")},_hide:function(){this._idleListener&&this.options.map.off("moveend",this._idleListener);this._zoomChangeListener&&this.options.map.off("zoomend",this._zoomChangeListener);this._autoUpdateInterval&&clearInterval(this._autoUpdateInterval);this._lastQueriedBounds=
null;this._gotAll&&(this._gotAll=!1);return this._clearFeatures()},_hideVectors:function(){return this.options.map.removeLayer(this.layer)},_showVectors:function(){return this.layer.addTo(this.options.map)},_clearFeatures:function(){this._vectors=[];return this.layer.clearLayers()},_addZoomChangeListener:function(){this._zoomChangeListener=this._zoomChangeListenerTemplate();return this.options.map.on("zoomend",this._zoomChangeListener,this)},_zoomChangeListenerTemplate:function(){var a=this;return function(){return a._checkLayerVisibility()}},
_idleListenerTemplate:function(){var a=this;return function(){if(a.options.visibleAtScale)if(a.options.showAll){if(!a._gotAll)return a._getFeatures(),a._gotAll=!0}else return a._hide(),a._getFeatures()}},_addIdleListener:function(){this._idleListener=this._idleListenerTemplate();return this.options.map.on("moveend",this._idleListener,this)},_checkLayerVisibility:function(){var a,c,b;c=this.options.visibleAtScale;b=this.options.map.getZoom();a=this.options.scaleRange;this.options.visibleAtScale=b>=
a[0]&&b<=a[1];if(c!==this.options.visibleAtScale)this[this.options.visibleAtScale?"_showVectors":"_hideVectors"]();if(c&&!this.options.visibleAtScale&&this._autoUpdateInterval)return clearInterval(this._autoUpdateInterval);if(!c&&this.options.autoUpdate&&this.options.autoUpdateInterval)return this._autoUpdateInterval=setInterval(function(){return this._getFeatures()},this.options.autoUpdateInterval)},_setPopupContent:function(a){var c,b,d,e,f;d=a.popupContent;c=a.properties;if("string"===typeof this.options.popupTemplate)for(e in b=
this.options.popupTemplate,c)f=RegExp("{"+e+"}","g"),b=b.replace(f,c[e]);else if("function"===typeof this.options.popupTemplate)b=this.options.popupTemplate(c);else return;a.popupContent=b;if(a.popup){if(a.popupContent!==d)return a.popup.setContent(a.popupContent)}else if(this.popup&&this.popup.associatedFeature===a&&a.popupContent!==d)return this.popup.setContent(a.popupContent)},_showPopup:function(a,c){var b,d;(b=c.latlng)||L.Util.extend(this.options.popupOptions,{offset:c.target.options.icon.options.popupAnchor});
this.options.singlePopup?(this.popup&&(this.options.map.removeLayer(this.popup),this.popup=null),this.popup=new L.Popup(this.options.popupOptions,a.vector),this.popup.associatedFeature=a,d=this):(a.popup=new L.Popup(this.options.popupOptions,a.vector),d=a);d.popup.setLatLng(b?c.latlng:c.target.getLatLng());d.popup.setContent(a.popupContent);return this.options.map.addLayer(d.popup)},_fireClickEvent:function(a,c){return this.options.clickEvent(a,c)},_fireMouseoverEvent:function(a,c){return this.options.mouseoverEvent(a,
c)},_fireMouseoutEvent:function(a,c){return this.options.mouseoutEvent(a,c)},_getFeatureVectorOptions:function(a){var c,b,d,e,f,g,h,k;g={};c=a.properties;if(this.options.symbology)switch(this.options.symbology.type){case "single":for(d in this.options.symbology.vectorStyle)if(g[d]=this.options.symbology.vectorStyle[d],g.title)for(e in c)f=RegExp("{"+e+"}","g"),g.title=g.title.replace(f,c[e]);break;case "unique":a=this.options.symbology.property;b=h=0;for(k=this.options.symbology.values.length;0<=
k?h<k:h>k;b=0<=k?++h:--h)if(c[a]===this.options.symbology.values[b].value)for(d in this.options.symbology.values[b].vectorStyle)if(g[d]=this.options.symbology.values[b].vectorStyle[d],g.title)for(e in c)f=RegExp("{"+e+"}","g"),g.title=g.title.replace(f,c[e]);break;case "range":for(a=this.options.symbology.property,b=h=0,k=this.options.symbology.ranges.length;0<=k?h<k:h>k;b=0<=k?++h:--h)if(c[a]>=this.options.symbology.ranges[b].range[0]&&c[a]<=this.options.symbology.ranges[b].range[1])for(d in this.options.symbology.ranges[b].vectorStyle)if(g[d]=
this.options.symbology.ranges[b].vectorStyle[d],g.title)for(e in c)f=RegExp("{"+e+"}","g"),g.title=g.title.replace(f,c[e])}return g},_getPropertiesChanged:function(a,c){var b,d;b=!1;for(d in a)a[d]!==c[d]&&(b=!0);return b},_getPropertyChanged:function(a,c,b){return a[b]!==c[b]},_getGeometryChanged:function(a,c){var b;b=!1;if(a.coordinates[0]!==c.coordinates[0]||a.coordinates[1]!==c.coordinates[1])b=!0;return b},_makeJsonpRequest:function(a){var c=this;return $.ajax({url:a,type:"GET",dataType:"jsonp",
crossDomain:!0,success:function(a){return c._processRequest(a)},error:function(a,c,e){return console.log("Failed URL request: "+e)}})},_processRequest:function(a){var c,b,d,e,f;c={features:[]};c.total=a.length;c.type="FeatureCollection";b=e=0;for(f=a.length;0<=f?e<f:e>f;b=0<=f?++e:--e)for(d in c.features[b]={},c.features[b].type="Feature",c.features[b].properties={},a[b])"geojson"===d?c.features[b].geometry=JSON.parse(a[b].geojson):"properties"!==d&&(c.features[b].properties[d]=a[b][d]);return this._processFeatures(c)},
_processFeatures:function(a){var c,b,d,e,f,g,h,k,l,m,n;if(this.options.map&&(c=this.options.map.getBounds(),!this._lastQueriedBounds||!this._lastQueriedBounds.equals(c)||this.options.autoUpdate)){this._lastQueriedBounds=c;this.layer.addTo(this.options.map);if(a&&a.features&&a.features.length)for(c=h=0,l=a.features.length;0<=l?h<l:h>l;c=0<=l?++h:--h){d=!1;if(this.options.uniqueField)for(b=k=0,m=this._vectors.length;0<=m?k<m:k>m;b=0<=m?++k:--k)if(a.features[c].properties[this.options.uniqueField]===
this._vectors[b].properties[this.options.uniqueField]&&(d=!0,this.options.dynamic&&(!this._getGeometryChanged(this._vectors[b].geometry,a.features[c].geometry)||(isNaN(a.features[c].geometry.coordinates[0])||isNaN(a.features[c].geometry.coordinates[1]))||(this._vectors[b].geometry=a.features[c].geometry,this._vectors[b].vector.setLatLng(new L.LatLng(this._vectors[b].geometry.coordinates[1],this._vectors[b].geometry.coordinates[0]))),g=this._getPropertiesChanged(this._vectors[b].properties,a.features[c].properties)))&&
(g=this._getPropertyChanged(this._vectors[b].properties,a.features[c].properties,this.options.symbology.property),this._vectors[b].properties=a.features[c].properties,this.options.popupTemplate&&this._setPopupContent(this._vectors[b]),this.options.symbology&&"single"!==this.options.symbology.type&&g))if(this._vectors[b].vectors)for(e=g=0,n=this._vectors[b].vectors.length;0<=n?g<n:g>n;e=0<=n?++g:--g)this._vectors[b].vectors[e].setStyle?this._vectors[b].vectors[e].setStyle(this._getFeatureVectorOptions(this._vectors[b])):
this._vectors[b].vectors[e].setIcon&&this._vectors[b].vectors[e].setIcon(this._getFeatureVectorOptions(this._vectors[b]).icon);else this._vectors[b].vector&&(this._vectors[b].vector.setStyle?this._vectors[b].vector.setStyle(this._getFeatureVectorOptions(this._vectors[b])):this._vectors[b].vector.setIcon&&this._vectors[b].vector.setIcon(this._getFeatureVectorOptions(this._vectors[b]).icon));if(!d||!this.options.uniqueField){b=a.features[c].geometry;d=this._getFeatureVectorOptions(a.features[c]);b=
this._geoJsonGeometryToLeaflet(b,d);a.features[c][b instanceof Array?"vectors":"vector"]=b;this._vectors.push(a.features[c]);if(this._vectors[c].vector)this.layer.addLayer(this._vectors[c].vector);else if(this._vectors[c].vectors&&this._vectors[c].vectors.length)for(e=b=0,d=this._vectors[c].vectors.length;0<=d?b<d:b>d;e=0<=d?++b:--b)this.layer.addLayer(this._vectors[c].vectors[e]);this.options.popupTemplate&&(f=this,b=a.features[c],this._setPopupContent(b),function(a){var b,c,d;if(a.vector)return a.vector.on("click",
function(b){return f._showPopup(a,b)});if(a.vectors){d=[];e=b=0;for(c=a.vectors.length;0<=c?b<c:b>c;e=0<=c?++b:--b)d.push(a.vectors[e].on("click",function(b){return f._showPopup(a,b)}));return d}}(b));this.options.clickEvent&&(f=this,b=a.features[c],function(a){var b,c,d;if(a.vector)return a.vector.on("click",function(b){return f._fireClickEvent(a,b)});if(a.vectors){d=[];e=b=0;for(c=a.vectors.length;0<=c?b<c:b>c;e=0<=c?++b:--b)d.push(a.vectors[e].on("click",function(b){return f._fireClickEvent(a,
b)}));return d}}(b));this.options.mouseoverEvent&&(f=this,b=a.features[c],function(a){var b,c,d;if(a.vector)return a.vector.on("mouseover",function(b){return f._fireMouseoverEvent(a,b)});if(a.vectors){d=[];e=b=0;for(c=a.vectors.length;0<=c?b<c:b>c;e=0<=c?++b:--b)d.push(a.vectors[e].on("mouseover",function(b){return f._fireMouseoverEvent(a,b)}));return d}}(b));this.options.mouseoutEvent&&(f=this,b=a.features[c],function(a){var b,c,d;if(a.vector)return a.vector.on("mouseout",function(b){return f._fireMouseoutEvent(a,
b)});if(a.vectors){d=[];e=b=0;for(c=a.vectors.length;0<=c?b<c:b>c;e=0<=c?++b:--b)d.push(a.vectors[e].on("mouseout",function(b){return f._fireMouseoutEvent(a,b)}));return d}}(b))}}this.options.above&&this.layer.eachLayer(function(a){if(a.setZIndexOffset)return a.setZIndexOffset(1E3)});this.options.focus&&this.options.map.fitBounds(this.layer.getBounds());return a=null}}});vectorLayer.GeoJSONLayer=vectorLayer.Layer.extend({_geoJsonGeometryToLeaflet:function(a,c){var b,d,e,f,g,h,k,l,m,n,p,q,r;k=h=void 0;
switch(a.type){case "Point":h=c.circleMarker?new L.CircleMarker(new L.LatLng(a.coordinates[1],a.coordinates[0]),c):new L.Marker(new L.LatLng(a.coordinates[1],a.coordinates[0]),c);break;case "MultiPoint":k=[];b=f=0;for(d=a.coordinates.length;0<=d?f<d:f>d;b=0<=d?++f:--f)k.push(new L.Marker(new L.LatLng(a.coordinates[b][1],a.coordinates[b][0]),c));break;case "LineString":f=[];b=d=0;for(h=a.coordinates.length;0<=h?d<h:d>h;b=0<=h?++d:--d)f.push(new L.LatLng(a.coordinates[b][1],a.coordinates[b][0]));h=
new L.Polyline(f,c);break;case "MultiLineString":k=[];b=g=0;for(l=a.coordinates.length;0<=l?g<l:g>l;b=0<=l?++g:--g){f=[];d=e=0;for(m=a.coordinates[b].length;0<=m?e<m:e>m;d=0<=m?++e:--e)f.push(new L.LatLng(a.coordinates[b][d][1],a.coordinates[b][d][0]));k.push(new L.Polyline(f,c))}break;case "Polygon":g=[];b=h=0;for(l=a.coordinates.length;0<=l?h<l:h>l;b=0<=l?++h:--h){f=[];d=e=0;for(m=a.coordinates[b].length;0<=m?e<m:e>m;d=0<=m?++e:--e)f.push(new L.LatLng(a.coordinates[b][d][1],a.coordinates[b][d][0]));
g.push(f)}h=new L.Polygon(g,c);break;case "MultiPolygon":k=[];b=l=0;for(p=a.coordinates.length;0<=p?l<p:l>p;b=0<=p?++l:--l){g=[];d=m=0;for(q=a.coordinates[b].length;0<=q?m<q:m>q;d=0<=q?++m:--m){f=[];e=n=0;for(r=a.coordinates[b][d].length;0<=r?n<r:n>r;e=0<=r?++n:--n)f.push(new L.LatLng(a.coordinates[b][d][e][1],a.coordinates[b][d][e][0]));g.push(f)}k.push(new L.Polygon(g,c))}break;case "GeometryCollection":for(k=[],b=f=0,d=a.coordinates.length;0<=d?f<d:f>d;b=0<=d?++f:--f)k.push(this._geoJsonGeometryToLeaflet(a.geometries[b],
c))}return h||k}});vectorLayer.Postgis=vectorLayer.GeoJSONLayer.extend({initialize:function(a){var c,b,d;c=b=0;for(d=this._requiredParams.length;0<=d?b<d:b>d;c=0<=d?++b:--b)if(!a[this._requiredParams[c]])throw Error('No "'+this._requiredParams[c]+'" parameter found.');"/"!==a.url.substr(a.url.length-1,1)&&(a.url+="/");vectorLayer.Layer.prototype.initialize.call(this,a);this._globalPointer="Postgis_"+this.options.geotable+"_"+this.options.geomFieldName;window[this._globalPointer]=this;this._vectors=
[];this.layer=this.options.cluster?new L.MarkerClusterGroup:new L.featureGroup;if(this.options.map)return this.options.scaleRange&&(this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length)&&(c=this.options.map.getZoom(),a=this.options.scaleRange,this.options.visibleAtScale=c>=a[0]&&c<=a[1]),this._show()},options:{geotable:null,srid:null,geomFieldName:"the_geom",fields:null,where:null,limit:5E3,uniqueField:null},_requiredParams:["url","geotable"],_getFeatures:function(){var a,
c,b;b=this.options.where?"&parameters="+encodeURIComponent(this.options.where):"";this.options.showAll||(a=this.options.map.getBounds(),c=a.getSouthWest(),a=a.getNorthEast(),b+=b.length?" AND ":"",b=this.options.srid?b+encodeURIComponent("st_setsrid("+this.options.geomFieldName+","+this.options.srid+") && st_setsrid(st_makebox2d(st_point("+c.lng+","+c.lat+"),st_point("+a.lng+","+a.lat+")),"+this.options.srid+")"):b+encodeURIComponent(""+this.options.geomFieldName+" && st_setsrid(st_makebox2d(st_point("+
c.lng+","+c.lat+"),st_point("+a.lng+","+a.lat+"))"));c=this.options.url+"v1/ws_geo_attributequery.php?table="+this.options.geotable+"&fields="+encodeURIComponent((this.options.fields?this.options.fields:"*")+", st_asgeojson("+this.options.geomFieldName+""+(this.options.geomPrecision?","+this.options.geomPrecision:"")+") as geojson")+b+"&limit="+this.options.limit;return this._makeJsonpRequest(c)}});vectorLayer.Geoserver=vectorLayer.GeoJSONLayer.extend({initialize:function(a){var c,b;c=0;for(b=this._requiredParams.length;c<
b;){if(!a[this._requiredParams[c]])throw Error('No "'+this._requiredParams[c]+'" parameter found.');c++}lvector.Layer.prototype.initialize.call(this,a);this._globalPointer="Geoserver_"+Math.floor(1E5*Math.random());window[this._globalPointer]=this;this._vectors=[];if(this.options.map)return this.options.scaleRange&&(this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length)&&(c=this.options.map.getZoom(),a=this.options.scaleRange(),this.options.visibleAtScale=c>=a[0]&&c<=a[1]),
this._show()},options:{baseUrl:null,typeName:null,uniqueField:null},_requiredParams:["baseUrl","typeName","uniqueField"],_getFeatures:function(){var a;a=this.options.baseUrl.replace(/\?$/,"")+"?service=WFS&version=1.1.0&request=GetFeature&typeName="+this.options.typeName+"&outputFormat=json&format_options=callback:"+this._globalPointer+"._processRequest";this.options.showAll||(a+="&bbox="+this.options.map.getBounds().toBBoxString());return this._makeJsonpRequest(a)}})}).call(this);
